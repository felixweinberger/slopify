<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat - Slopify</title>
  <link rel="stylesheet" href="../../styles.css">
  <style>
    html, body {
      height: 100%;
      margin: 0;
      overflow: hidden;
    }

    .container {
      max-width: 1200px;
      height: 100vh;
      display: flex;
      flex-direction: column;
      padding-top: 1rem;
      padding-bottom: 1rem;
      box-sizing: border-box;
    }

    header {
      flex-shrink: 0;
      padding-bottom: 0.5rem;
    }

    header h1 {
      margin: 0.25rem 0;
      font-size: 1.75rem;
    }

    header .tagline {
      margin: 0;
      font-size: 0.875rem;
    }

    main {
      flex: 1;
      min-height: 0;
      display: flex;
      flex-direction: column;
    }

    #app-content {
      flex: 1;
      min-height: 0;
      display: flex;
    }

    .chat-layout {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 1rem;
      flex: 1;
      min-height: 0;
    }

    /* User List Panel */
    .users-panel {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 1rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 0;
    }

    .users-panel-header {
      padding: 1rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      flex-shrink: 0;
    }

    .users-panel-header h2 {
      color: var(--cyan);
      font-size: 1.125rem;
      margin: 0;
    }

    .search-box {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 0.5rem;
      background: rgba(255, 255, 255, 0.05);
      color: var(--light);
      font-size: 0.875rem;
      font-family: inherit;
      margin-top: 0.5rem;
      box-sizing: border-box;
    }

    .search-box:focus {
      outline: none;
      border-color: var(--purple);
    }

    .users-list {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem;
      min-height: 0;
    }

    .user-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: background 0.2s;
      position: relative;
    }

    .user-item:hover {
      background: rgba(255, 255, 255, 0.08);
    }

    .user-item.active {
      background: rgba(139, 92, 246, 0.2);
    }

    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 2px solid var(--purple);
      flex-shrink: 0;
    }

    .user-item-info {
      flex: 1;
      min-width: 0;
    }

    .user-item-name {
      color: var(--light);
      font-weight: 500;
      font-size: 0.875rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Chat Panel */
    .chat-panel {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 1rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 0;
    }

    .chat-header {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-shrink: 0;
    }

    .chat-header h2 {
      color: var(--cyan);
      font-size: 1.125rem;
      margin: 0;
      flex: 1;
    }

    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      min-height: 0;
    }

    .message {
      display: flex;
      gap: 0.5rem;
      max-width: 80%;
    }

    .message.sent {
      align-self: flex-end;
      flex-direction: row-reverse;
    }

    .message-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .message-content {
      flex: 1;
    }

    .message-header {
      display: flex;
      gap: 0.5rem;
      align-items: baseline;
      margin-bottom: 0.2rem;
    }

    .message-author {
      font-weight: 600;
      font-size: 0.8rem;
      color: var(--cyan);
    }

    .message-time {
      font-size: 0.7rem;
      color: rgba(255, 255, 255, 0.5);
    }

    .message-bubble {
      background: rgba(255, 255, 255, 0.08);
      padding: 0.6rem 0.75rem;
      border-radius: 0.75rem;
      word-wrap: break-word;
      border: 1px solid rgba(255, 255, 255, 0.1);
      font-size: 0.9rem;
    }

    .message.sent .message-bubble {
      background: rgba(139, 92, 246, 0.3);
      border-color: rgba(139, 92, 246, 0.4);
    }

    .message-input-container {
      padding: 0.75rem 1rem;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      gap: 0.5rem;
      flex-shrink: 0;
    }

    .message-input {
      flex: 1;
      padding: 0.6rem 0.75rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 0.5rem;
      background: rgba(255, 255, 255, 0.05);
      color: var(--light);
      font-size: 0.9rem;
      font-family: inherit;
      resize: none;
    }

    .message-input:focus {
      outline: none;
      border-color: var(--purple);
    }

    .send-btn {
      background: linear-gradient(90deg, var(--pink), var(--purple));
      color: white;
      border: none;
      padding: 0.6rem 1.25rem;
      border-radius: 0.5rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, opacity 0.2s;
    }

    .send-btn:hover:not(:disabled) {
      transform: translateY(-1px);
    }

    .send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: rgba(255, 255, 255, 0.5);
      text-align: center;
      padding: 2rem;
    }

    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 0.75rem;
    }

    .loading {
      text-align: center;
      padding: 2rem;
      opacity: 0.7;
    }

    .error {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid rgba(239, 68, 68, 0.5);
      color: #fca5a5;
      padding: 1rem;
      border-radius: 0.5rem;
      text-align: center;
      margin: 1rem;
    }

    .error a {
      color: var(--cyan);
    }

    .back-link {
      color: var(--cyan);
      text-decoration: none;
      font-size: 0.875rem;
    }

    .back-link:hover {
      text-decoration: underline;
    }

    @media (max-width: 768px) {
      .chat-layout {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
      }

      .users-panel {
        max-height: 200px;
      }

      .message {
        max-width: 90%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <a href="/" class="back-link">‚Üê Back to Slopify</a>
      <h1>Chat</h1>
      <p class="tagline">Message other Slopify users</p>
    </header>
    <main>
      <div id="app-content">
        <div class="loading">Loading chat...</div>
      </div>
    </main>
  </div>

  <script>
    let currentUser = null;
    let selectedUser = null;
    let allUsers = [];
    let messages = [];
    let pollInterval = null;
    let lastMessageTime = 0;

    async function init() {
      try {
        // Check if logged in
        const meResponse = await fetch('/api/me');
        if (!meResponse.ok) {
          showError('Please <a href="/">log in</a> to use the chat.');
          return;
        }
        const meData = await meResponse.json();
        if (!meData.user) {
          showError('Please <a href="/">log in</a> to use the chat.');
          return;
        }
        currentUser = meData.user;

        // Check if we're starting a chat from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const chatWith = urlParams.get('with');

        await loadUsers();

        if (chatWith) {
          const user = allUsers.find(u => u.username === chatWith);
          if (user) {
            selectedUser = user;
            await loadMessages();
          }
        }

        renderChatLayout();
        startPolling();
      } catch (error) {
        console.error('Init error:', error);
        showError('Failed to initialize chat. Please try again.');
      }
    }

    async function loadUsers() {
      const response = await fetch('/api/users');
      if (!response.ok) throw new Error('Failed to fetch users');
      const data = await response.json();
      allUsers = (data.users || []).filter(u => u.username !== currentUser.username);
    }

    async function loadMessages() {
      if (!selectedUser) return;

      const url = lastMessageTime
        ? `/api/messages?with=${selectedUser.username}&since=${lastMessageTime}`
        : `/api/messages?with=${selectedUser.username}`;

      const response = await fetch(url);
      if (!response.ok) throw new Error('Failed to fetch messages');

      const data = await response.json();

      if (lastMessageTime && data.messages.length > 0) {
        // Append new messages
        messages = [...messages, ...data.messages];
      } else if (!lastMessageTime) {
        // Initial load
        messages = data.messages || [];
      }

      if (messages.length > 0) {
        lastMessageTime = messages[messages.length - 1].createdAt;
      }
    }

    async function selectUser(username) {
      selectedUser = allUsers.find(u => u.username === username);
      messages = [];
      lastMessageTime = 0;

      if (selectedUser) {
        await loadMessages();
      }

      renderChatLayout();
      scrollToBottom();
    }

    function renderChatLayout() {
      const content = document.getElementById('app-content');

      content.innerHTML = `
        <div class="chat-layout">
          <div class="users-panel">
            <div class="users-panel-header">
              <h2>Users</h2>
              <input
                type="text"
                class="search-box"
                id="search-input"
                placeholder="Search users..."
                autocomplete="off"
              >
            </div>
            <div class="users-list" id="users-list">
              ${renderUsersList()}
            </div>
          </div>
          <div class="chat-panel">
            ${renderChatPanel()}
          </div>
        </div>
      `;

      document.getElementById('search-input')?.addEventListener('input', handleSearch);
      document.getElementById('message-input')?.addEventListener('keydown', handleKeyDown);
    }

    function renderUsersList() {
      if (allUsers.length === 0) {
        return '<div class="empty-state"><div>No other users yet</div></div>';
      }

      return allUsers.map(user => {
        const isActive = selectedUser?.username === user.username;
        return `
          <div class="user-item ${isActive ? 'active' : ''}" onclick="selectUser('${user.username}')">
            <img
              src="${user.avatarUrl || 'https://github.com/github.png'}"
              alt="${user.username}"
              class="user-avatar"
            >
            <div class="user-item-info">
              <div class="user-item-name">@${user.username}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderChatPanel() {
      if (!selectedUser) {
        return `
          <div class="empty-state">
            <div class="empty-state-icon">üí¨</div>
            <div>Select a user to start chatting</div>
          </div>
        `;
      }

      const messagesHTML = messages.map(msg => {
        const isSent = msg.fromUserId === currentUser.id;
        const avatarUrl = isSent ? currentUser.avatarUrl : selectedUser.avatarUrl;
        const username = isSent ? currentUser.username : selectedUser.username;
        const time = formatTime(msg.createdAt);

        return `
          <div class="message ${isSent ? 'sent' : 'received'}">
            <img
              src="${avatarUrl || 'https://github.com/github.png'}"
              alt="${username}"
              class="message-avatar"
            >
            <div class="message-content">
              <div class="message-header">
                <span class="message-author">@${username}</span>
                <span class="message-time">${time}</span>
              </div>
              <div class="message-bubble">${escapeHtml(msg.content)}</div>
            </div>
          </div>
        `;
      }).join('');

      return `
        <div class="chat-header">
          <img
            src="${selectedUser.avatarUrl || 'https://github.com/github.png'}"
            alt="${selectedUser.username}"
            class="user-avatar"
          >
          <h2>@${selectedUser.username}</h2>
        </div>
        <div class="messages-container" id="messages-container">
          ${messagesHTML || '<div class="empty-state"><div>No messages yet. Say hi!</div></div>'}
        </div>
        <div class="message-input-container">
          <input
            type="text"
            id="message-input"
            class="message-input"
            placeholder="Type a message..."
          >
          <button class="send-btn" onclick="sendMessage()">Send</button>
        </div>
      `;
    }

    function handleSearch(event) {
      const query = event.target.value.toLowerCase().trim();
      const usersList = document.getElementById('users-list');

      const filtered = query
        ? allUsers.filter(user =>
            user.username.toLowerCase().includes(query) ||
            (user.displayName && user.displayName.toLowerCase().includes(query))
          )
        : allUsers;

      if (filtered.length === 0) {
        usersList.innerHTML = '<div class="empty-state"><div>No users found</div></div>';
        return;
      }

      usersList.innerHTML = filtered.map(user => {
        const isActive = selectedUser?.username === user.username;
        return `
          <div class="user-item ${isActive ? 'active' : ''}" onclick="selectUser('${user.username}')">
            <img
              src="${user.avatarUrl || 'https://github.com/github.png'}"
              alt="${user.username}"
              class="user-avatar"
            >
            <div class="user-item-info">
              <div class="user-item-name">@${user.username}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function handleKeyDown(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    }

    async function sendMessage() {
      if (!selectedUser) return;

      const input = document.getElementById('message-input');
      const text = input.value.trim();
      if (!text) return;

      // Clear input immediately
      input.value = '';

      try {
        const response = await fetch('/api/messages', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ to: selectedUser.username, content: text })
        });

        if (!response.ok) {
          const err = await response.json();
          console.error('Send error:', err);
          return;
        }

        const data = await response.json();

        // Add message to local list
        messages.push({
          id: Date.now(),
          fromUserId: currentUser.id,
          fromUsername: currentUser.username,
          toUserId: selectedUser.id,
          toUsername: selectedUser.username,
          content: text,
          createdAt: data.timestamp
        });

        lastMessageTime = data.timestamp;
        renderChatLayout();
        scrollToBottom();
      } catch (err) {
        console.error('Send error:', err);
      }
    }

    function startPolling() {
      pollInterval = setInterval(async () => {
        if (!selectedUser) return;

        try {
          const prevCount = messages.length;
          await loadMessages();

          if (messages.length > prevCount) {
            renderChatLayout();
            scrollToBottom();
          }
        } catch (err) {
          console.error('Poll error:', err);
        }
      }, 2000);
    }

    function scrollToBottom() {
      setTimeout(() => {
        const container = document.getElementById('messages-container');
        if (container) {
          container.scrollTop = container.scrollHeight;
        }
      }, 50);
    }

    function formatTime(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) return 'Just now';
      if (diffMins < 60) return `${diffMins}m ago`;
      if (diffHours < 24) return `${diffHours}h ago`;
      if (diffDays < 7) return `${diffDays}d ago`;

      return date.toLocaleDateString();
    }

    function showError(message) {
      const content = document.getElementById('app-content');
      content.innerHTML = `<div class="error">${message}</div>`;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    window.addEventListener('beforeunload', () => {
      if (pollInterval) clearInterval(pollInterval);
    });

    init();
  </script>
</body>
</html>
