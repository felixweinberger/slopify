<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat - Slopify</title>
  <link rel="stylesheet" href="../../styles.css">
  <style>
    .container {
      max-width: 1200px;
    }

    .chat-layout {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 1rem;
      height: calc(100vh - 16rem);
      min-height: 500px;
    }

    /* User List Panel */
    .users-panel {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 1rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .users-panel-header {
      padding: 1rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .users-panel-header h2 {
      color: var(--cyan);
      font-size: 1.25rem;
      margin: 0;
    }

    .search-box {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 0.5rem;
      background: rgba(255, 255, 255, 0.05);
      color: var(--light);
      font-size: 0.875rem;
      font-family: inherit;
      margin-top: 0.5rem;
    }

    .search-box:focus {
      outline: none;
      border-color: var(--purple);
    }

    .users-list {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem;
    }

    .user-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: background 0.2s;
      position: relative;
    }

    .user-item:hover {
      background: rgba(255, 255, 255, 0.08);
    }

    .user-item.active {
      background: rgba(139, 92, 246, 0.2);
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 2px solid var(--purple);
      flex-shrink: 0;
    }

    .user-item-info {
      flex: 1;
      min-width: 0;
    }

    .user-item-name {
      color: var(--light);
      font-weight: 500;
      font-size: 0.875rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .user-item-preview {
      color: rgba(255, 255, 255, 0.5);
      font-size: 0.75rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .unread-badge {
      background: var(--pink);
      color: white;
      font-size: 0.7rem;
      font-weight: 600;
      padding: 0.15rem 0.4rem;
      border-radius: 10px;
      min-width: 18px;
      text-align: center;
    }

    /* Chat Panel */
    .chat-panel {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 1rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .chat-header {
      padding: 1rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .chat-header h2 {
      color: var(--cyan);
      font-size: 1.25rem;
      margin: 0;
      flex: 1;
    }

    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .message {
      display: flex;
      gap: 0.75rem;
      max-width: 80%;
    }

    .message.sent {
      align-self: flex-end;
      flex-direction: row-reverse;
    }

    .message-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .message-content {
      flex: 1;
    }

    .message-header {
      display: flex;
      gap: 0.5rem;
      align-items: baseline;
      margin-bottom: 0.25rem;
    }

    .message-author {
      font-weight: 600;
      font-size: 0.875rem;
      color: var(--cyan);
    }

    .message-time {
      font-size: 0.75rem;
      color: rgba(255, 255, 255, 0.5);
    }

    .message-bubble {
      background: rgba(255, 255, 255, 0.08);
      padding: 0.75rem;
      border-radius: 0.75rem;
      word-wrap: break-word;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .message.sent .message-bubble {
      background: rgba(139, 92, 246, 0.3);
      border-color: rgba(139, 92, 246, 0.4);
    }

    .message-input-container {
      padding: 1rem;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      gap: 0.5rem;
    }

    .message-input {
      flex: 1;
      padding: 0.75rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 0.5rem;
      background: rgba(255, 255, 255, 0.05);
      color: var(--light);
      font-size: 1rem;
      font-family: inherit;
      resize: none;
      max-height: 120px;
    }

    .message-input:focus {
      outline: none;
      border-color: var(--purple);
    }

    .send-btn {
      background: linear-gradient(90deg, var(--pink), var(--purple));
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, opacity 0.2s;
    }

    .send-btn:hover:not(:disabled) {
      transform: translateY(-1px);
    }

    .send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: rgba(255, 255, 255, 0.5);
      text-align: center;
      padding: 2rem;
    }

    .empty-state-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }

    .loading {
      text-align: center;
      padding: 2rem;
      opacity: 0.7;
    }

    .error {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid rgba(239, 68, 68, 0.5);
      color: #fca5a5;
      padding: 1rem;
      border-radius: 0.5rem;
      text-align: center;
      margin: 1rem;
    }

    .back-link {
      color: var(--cyan);
      text-decoration: none;
      display: inline-block;
      margin-bottom: 1rem;
    }

    .back-link:hover {
      text-decoration: underline;
    }

    @media (max-width: 768px) {
      .chat-layout {
        grid-template-columns: 1fr;
        height: auto;
      }

      .users-panel {
        max-height: 300px;
      }

      .chat-panel {
        min-height: 500px;
      }

      .message {
        max-width: 90%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <a href="/" class="back-link">‚Üê Back to Slopify</a>
      <h1>üí¨ Chat</h1>
      <p class="tagline">Message other Slopify users</p>
    </header>
    <main>
      <div id="app-content">
        <div class="loading">Loading chat...</div>
      </div>
    </main>
  </div>

  <script src="../slopify-sdk.js"></script>
  <script>
    let sdk;
    let currentUser = null;
    let selectedUser = null;
    let allUsers = [];
    let conversations = {};
    let unreadCounts = {};
    let pollInterval = null;

    async function init() {
      try {
        sdk = await new SlopifySDK('chat').init();

        if (!sdk.isLoggedIn) {
          showError('Please <a href="/">log in</a> to use the chat.');
          return;
        }

        currentUser = sdk.user;

        // Check if we're starting a chat from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const chatWith = urlParams.get('with');

        await loadUsers();

        if (chatWith && allUsers.find(u => u.username === chatWith)) {
          selectUser(chatWith);
        }

        renderChatLayout();
        startPolling();
      } catch (error) {
        console.error('Init error:', error);
        showError('Failed to initialize chat. Please try again.');
      }
    }

    async function loadUsers() {
      try {
        const response = await fetch('/api/users');

        if (!response.ok) {
          throw new Error('Failed to fetch users');
        }

        const data = await response.json();
        allUsers = (data.users || []).filter(u => u.username !== currentUser.username);

        // Load conversation data from backend
        const savedData = await sdk.getAll();
        conversations = savedData.conversations || {};
        unreadCounts = savedData.unreadCounts || {};

      } catch (error) {
        console.error('Load users error:', error);
        throw error;
      }
    }

    function selectUser(username) {
      selectedUser = allUsers.find(u => u.username === username);

      // Mark messages as read
      if (unreadCounts[username]) {
        unreadCounts[username] = 0;
        saveData();
      }

      renderChatLayout();
      scrollToBottom();
    }

    function renderChatLayout() {
      const content = document.getElementById('app-content');

      const usersListHTML = renderUsersList();
      const chatPanelHTML = renderChatPanel();

      content.innerHTML = `
        <div class="chat-layout">
          <div class="users-panel">
            <div class="users-panel-header">
              <h2>Conversations</h2>
              <input
                type="text"
                class="search-box"
                id="search-input"
                placeholder="Search users..."
                autocomplete="off"
              >
            </div>
            <div class="users-list" id="users-list">
              ${usersListHTML}
            </div>
          </div>
          <div class="chat-panel">
            ${chatPanelHTML}
          </div>
        </div>
      `;

      const searchInput = document.getElementById('search-input');
      searchInput?.addEventListener('input', handleSearch);

      const messageInput = document.getElementById('message-input');
      messageInput?.addEventListener('keydown', handleKeyDown);
    }

    function renderUsersList() {
      if (allUsers.length === 0) {
        return '<div class="empty-state"><div>No other users yet</div></div>';
      }

      // Sort users by last message time
      const sortedUsers = [...allUsers].sort((a, b) => {
        const aConv = conversations[a.username] || [];
        const bConv = conversations[b.username] || [];
        const aTime = aConv.length > 0 ? aConv[aConv.length - 1].timestamp : 0;
        const bTime = bConv.length > 0 ? bConv[bConv.length - 1].timestamp : 0;
        return bTime - aTime;
      });

      return sortedUsers.map(user => {
        const conv = conversations[user.username] || [];
        const lastMessage = conv[conv.length - 1];
        const unreadCount = unreadCounts[user.username] || 0;
        const isActive = selectedUser?.username === user.username;

        let preview = 'No messages yet';
        if (lastMessage) {
          const prefix = lastMessage.from === currentUser.username ? 'You: ' : '';
          preview = prefix + lastMessage.text.substring(0, 30) + (lastMessage.text.length > 30 ? '...' : '');
        }

        return `
          <div class="user-item ${isActive ? 'active' : ''}" onclick="selectUser('${user.username}')">
            <img
              src="${user.avatarUrl || 'https://github.com/github.png'}"
              alt="${user.username}"
              class="user-avatar"
            >
            <div class="user-item-info">
              <div class="user-item-name">@${user.username}</div>
              <div class="user-item-preview">${escapeHtml(preview)}</div>
            </div>
            ${unreadCount > 0 ? `<div class="unread-badge">${unreadCount}</div>` : ''}
          </div>
        `;
      }).join('');
    }

    function renderChatPanel() {
      if (!selectedUser) {
        return `
          <div class="empty-state">
            <div class="empty-state-icon">üí¨</div>
            <div>Select a user to start chatting</div>
          </div>
        `;
      }

      const messages = conversations[selectedUser.username] || [];
      const messagesHTML = messages.map(msg => {
        const isSent = msg.from === currentUser.username;
        const author = isSent ? currentUser : selectedUser;
        const time = formatTime(msg.timestamp);

        return `
          <div class="message ${isSent ? 'sent' : 'received'}">
            <img
              src="${author.avatarUrl || 'https://github.com/github.png'}"
              alt="${author.username}"
              class="message-avatar"
            >
            <div class="message-content">
              <div class="message-header">
                <span class="message-author">@${author.username}</span>
                <span class="message-time">${time}</span>
              </div>
              <div class="message-bubble">${escapeHtml(msg.text)}</div>
            </div>
          </div>
        `;
      }).join('');

      return `
        <div class="chat-header">
          <img
            src="${selectedUser.avatarUrl || 'https://github.com/github.png'}"
            alt="${selectedUser.username}"
            class="user-avatar"
          >
          <h2>@${selectedUser.username}</h2>
        </div>
        <div class="messages-container" id="messages-container">
          ${messagesHTML || '<div class="empty-state"><div>No messages yet. Start the conversation!</div></div>'}
        </div>
        <div class="message-input-container">
          <textarea
            id="message-input"
            class="message-input"
            placeholder="Type a message..."
            rows="1"
          ></textarea>
          <button class="send-btn" onclick="sendMessage()">Send</button>
        </div>
      `;
    }

    function handleSearch(event) {
      const query = event.target.value.toLowerCase().trim();
      const usersList = document.getElementById('users-list');

      if (!query) {
        usersList.innerHTML = renderUsersList();
        return;
      }

      const filtered = allUsers.filter(user =>
        user.username.toLowerCase().includes(query) ||
        (user.displayName && user.displayName.toLowerCase().includes(query))
      );

      if (filtered.length === 0) {
        usersList.innerHTML = '<div class="empty-state"><div>No users found</div></div>';
        return;
      }

      usersList.innerHTML = filtered.map(user => {
        const conv = conversations[user.username] || [];
        const lastMessage = conv[conv.length - 1];
        const unreadCount = unreadCounts[user.username] || 0;
        const isActive = selectedUser?.username === user.username;

        let preview = 'No messages yet';
        if (lastMessage) {
          const prefix = lastMessage.from === currentUser.username ? 'You: ' : '';
          preview = prefix + lastMessage.text.substring(0, 30) + (lastMessage.text.length > 30 ? '...' : '');
        }

        return `
          <div class="user-item ${isActive ? 'active' : ''}" onclick="selectUser('${user.username}')">
            <img
              src="${user.avatarUrl || 'https://github.com/github.png'}"
              alt="${user.username}"
              class="user-avatar"
            >
            <div class="user-item-info">
              <div class="user-item-name">@${user.username}</div>
              <div class="user-item-preview">${escapeHtml(preview)}</div>
            </div>
            ${unreadCount > 0 ? `<div class="unread-badge">${unreadCount}</div>` : ''}
          </div>
        `;
      }).join('');
    }

    function handleKeyDown(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    }

    async function sendMessage() {
      if (!selectedUser) return;

      const input = document.getElementById('message-input');
      const text = input.value.trim();

      if (!text) return;

      const message = {
        from: currentUser.username,
        to: selectedUser.username,
        text: text,
        timestamp: Date.now()
      };

      // Add to conversation
      if (!conversations[selectedUser.username]) {
        conversations[selectedUser.username] = [];
      }
      conversations[selectedUser.username].push(message);

      // Clear input
      input.value = '';

      // Save and re-render
      await saveData();
      renderChatLayout();
      scrollToBottom();
    }

    async function saveData() {
      await sdk.set('conversations', conversations);
      await sdk.set('unreadCounts', unreadCounts);
    }

    function startPolling() {
      // Poll for new messages every 3 seconds
      pollInterval = setInterval(async () => {
        await checkNewMessages();
      }, 3000);
    }

    async function checkNewMessages() {
      // In a real app with a backend, this would fetch new messages from the server
      // For this demo with localStorage-only persistence, we simulate checking
      // by reloading data and comparing

      try {
        const savedData = await sdk.getAll();
        const serverConversations = savedData.conversations || {};

        // Check each user's conversation for new messages
        let hasNewMessages = false;

        for (const username of Object.keys(serverConversations)) {
          const serverConv = serverConversations[username];
          const localConv = conversations[username] || [];

          if (serverConv.length > localConv.length) {
            // New messages detected
            const newMessages = serverConv.slice(localConv.length);

            // Only count as unread if not from current user and not currently viewing
            newMessages.forEach(msg => {
              if (msg.from !== currentUser.username && selectedUser?.username !== username) {
                unreadCounts[username] = (unreadCounts[username] || 0) + 1;
                hasNewMessages = true;
              }
            });

            conversations[username] = serverConv;
          }
        }

        if (hasNewMessages) {
          await saveData();
          renderChatLayout();
          if (selectedUser) {
            scrollToBottom();
          }
        }
      } catch (error) {
        console.error('Error checking new messages:', error);
      }
    }

    function scrollToBottom() {
      setTimeout(() => {
        const container = document.getElementById('messages-container');
        if (container) {
          container.scrollTop = container.scrollHeight;
        }
      }, 100);
    }

    function formatTime(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) return 'Just now';
      if (diffMins < 60) return `${diffMins}m ago`;
      if (diffHours < 24) return `${diffHours}h ago`;
      if (diffDays < 7) return `${diffDays}d ago`;

      return date.toLocaleDateString();
    }

    function showError(message) {
      const content = document.getElementById('app-content');
      content.innerHTML = `<div class="error">${message}</div>`;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (pollInterval) {
        clearInterval(pollInterval);
      }
    });

    init();
  </script>
</body>
</html>
