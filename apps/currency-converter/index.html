<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Currency Converter - Slopify</title>
  <link rel="stylesheet" href="../../styles.css">
  <style>
    .converter-container {
      max-width: 500px;
      margin: 2rem auto;
      padding: 2rem;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      backdrop-filter: blur(10px);
    }

    .currency-input {
      margin-bottom: 1.5rem;
    }

    .currency-input label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: var(--cyan);
    }

    .input-group {
      display: flex;
      gap: 0.5rem;
    }

    .input-group input {
      flex: 1;
      padding: 0.75rem;
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      background: rgba(0, 0, 0, 0.3);
      color: white;
      font-size: 1rem;
    }

    .input-group select {
      padding: 0.75rem;
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      background: rgba(0, 0, 0, 0.3);
      color: white;
      font-size: 1rem;
      cursor: pointer;
      min-width: 100px;
    }

    .input-group input:focus,
    .input-group select:focus {
      outline: none;
      border-color: var(--purple);
    }

    .swap-button {
      display: flex;
      justify-content: center;
      margin: 1rem 0;
    }

    .swap-button button {
      background: linear-gradient(135deg, var(--purple), var(--pink));
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      color: white;
      font-size: 1.5rem;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .swap-button button:hover {
      transform: scale(1.1);
    }

    .swap-button button:active {
      transform: scale(0.95);
    }

    .rate-display {
      text-align: center;
      padding: 1rem;
      margin: 1.5rem 0;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      font-size: 1.1rem;
      color: var(--yellow);
    }

    .last-updated {
      text-align: center;
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.6);
      margin-top: 1rem;
    }

    .loading {
      text-align: center;
      padding: 1rem;
      color: var(--cyan);
    }

    .error {
      text-align: center;
      padding: 1rem;
      color: var(--pink);
      background: rgba(255, 0, 100, 0.1);
      border-radius: 8px;
      margin: 1rem 0;
    }

    select option {
      background: #1a1a2e;
      color: white;
    }

    @media (max-width: 600px) {
      .converter-container {
        padding: 1rem;
        margin: 1rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <a href="/">‚Üê Back to Slopify</a>
      <h1>üí± Currency Converter</h1>
    </header>
    <main>
      <div class="converter-container">
        <div id="loading" class="loading">Loading exchange rates...</div>
        <div id="error" class="error" style="display: none;"></div>

        <div id="converter" style="display: none;">
          <div class="currency-input">
            <label for="from-amount">From</label>
            <div class="input-group">
              <input type="number" id="from-amount" placeholder="Enter amount" value="1" min="0" step="0.01">
              <select id="from-currency"></select>
            </div>
          </div>

          <div class="swap-button">
            <button id="swap-btn" title="Swap currencies">‚áÖ</button>
          </div>

          <div class="currency-input">
            <label for="to-amount">To</label>
            <div class="input-group">
              <input type="number" id="to-amount" placeholder="Converted amount" readonly>
              <select id="to-currency"></select>
            </div>
          </div>

          <div id="rate-display" class="rate-display"></div>
          <div id="last-updated" class="last-updated"></div>
        </div>
      </div>
    </main>
  </div>
  <script>
    const API_BASE = 'https://api.frankfurter.app';
    const CACHE_KEY = 'currency_rates';
    const CACHE_DURATION = 60 * 60 * 1000; // 1 hour
    const PREFS_KEY = 'currency_prefs';

    let rates = {};
    let lastUpdated = null;

    // Popular currencies to show
    const currencies = [
      { code: 'USD', name: 'US Dollar' },
      { code: 'EUR', name: 'Euro' },
      { code: 'GBP', name: 'British Pound' },
      { code: 'JPY', name: 'Japanese Yen' },
      { code: 'CAD', name: 'Canadian Dollar' },
      { code: 'AUD', name: 'Australian Dollar' },
      { code: 'CHF', name: 'Swiss Franc' },
      { code: 'CNY', name: 'Chinese Yuan' },
      { code: 'INR', name: 'Indian Rupee' },
      { code: 'MXN', name: 'Mexican Peso' },
      { code: 'BRL', name: 'Brazilian Real' },
      { code: 'ZAR', name: 'South African Rand' },
      { code: 'KRW', name: 'South Korean Won' },
      { code: 'SGD', name: 'Singapore Dollar' },
      { code: 'NZD', name: 'New Zealand Dollar' },
      { code: 'TRY', name: 'Turkish Lira' },
      { code: 'RUB', name: 'Russian Ruble' },
      { code: 'SEK', name: 'Swedish Krona' },
      { code: 'NOK', name: 'Norwegian Krone' },
      { code: 'DKK', name: 'Danish Krone' }
    ];

    const elements = {
      loading: document.getElementById('loading'),
      error: document.getElementById('error'),
      converter: document.getElementById('converter'),
      fromAmount: document.getElementById('from-amount'),
      toAmount: document.getElementById('to-amount'),
      fromCurrency: document.getElementById('from-currency'),
      toCurrency: document.getElementById('to-currency'),
      swapBtn: document.getElementById('swap-btn'),
      rateDisplay: document.getElementById('rate-display'),
      lastUpdated: document.getElementById('last-updated')
    };

    // Initialize the app
    async function init() {
      populateCurrencyDropdowns();
      loadPreferences();
      await fetchRates();

      if (Object.keys(rates).length > 0) {
        elements.loading.style.display = 'none';
        elements.converter.style.display = 'block';
        convert();
        setupEventListeners();
      }
    }

    // Populate currency dropdowns
    function populateCurrencyDropdowns() {
      currencies.forEach(currency => {
        const option1 = document.createElement('option');
        option1.value = currency.code;
        option1.textContent = `${currency.code} - ${currency.name}`;
        elements.fromCurrency.appendChild(option1);

        const option2 = document.createElement('option');
        option2.value = currency.code;
        option2.textContent = `${currency.code} - ${currency.name}`;
        elements.toCurrency.appendChild(option2);
      });
    }

    // Load user preferences
    function loadPreferences() {
      const prefs = localStorage.getItem(PREFS_KEY);
      if (prefs) {
        const { fromCurrency, toCurrency, amount } = JSON.parse(prefs);
        elements.fromCurrency.value = fromCurrency || 'USD';
        elements.toCurrency.value = toCurrency || 'EUR';
        elements.fromAmount.value = amount || 1;
      } else {
        elements.fromCurrency.value = 'USD';
        elements.toCurrency.value = 'EUR';
      }
    }

    // Save user preferences
    function savePreferences() {
      const prefs = {
        fromCurrency: elements.fromCurrency.value,
        toCurrency: elements.toCurrency.value,
        amount: elements.fromAmount.value
      };
      localStorage.setItem(PREFS_KEY, JSON.stringify(prefs));
    }

    // Fetch exchange rates
    async function fetchRates() {
      // Check cache first
      const cached = localStorage.getItem(CACHE_KEY);
      if (cached) {
        const { data, timestamp } = JSON.parse(cached);
        if (Date.now() - timestamp < CACHE_DURATION) {
          rates = data;
          lastUpdated = new Date(timestamp);
          updateLastUpdatedDisplay();
          return;
        }
      }

      // Fetch fresh rates
      try {
        const response = await fetch(`${API_BASE}/latest`);
        if (!response.ok) throw new Error('Failed to fetch rates');

        const data = await response.json();
        rates = { ...data.rates, [data.base]: 1 };
        lastUpdated = new Date();

        // Cache the rates
        localStorage.setItem(CACHE_KEY, JSON.stringify({
          data: rates,
          timestamp: Date.now()
        }));

        updateLastUpdatedDisplay();
      } catch (err) {
        showError('Failed to load exchange rates. Please try again later.');
        console.error(err);
      }
    }

    // Convert currency
    function convert() {
      const amount = parseFloat(elements.fromAmount.value) || 0;
      const from = elements.fromCurrency.value;
      const to = elements.toCurrency.value;

      if (!rates[from] || !rates[to]) return;

      // Convert via EUR as base
      const amountInEUR = amount / rates[from];
      const convertedAmount = amountInEUR * rates[to];

      elements.toAmount.value = convertedAmount.toFixed(2);

      // Update rate display
      const rate = rates[to] / rates[from];
      elements.rateDisplay.textContent = `1 ${from} = ${rate.toFixed(4)} ${to}`;

      savePreferences();
    }

    // Swap currencies
    function swap() {
      const tempCurrency = elements.fromCurrency.value;
      elements.fromCurrency.value = elements.toCurrency.value;
      elements.toCurrency.value = tempCurrency;

      const tempAmount = elements.fromAmount.value;
      elements.fromAmount.value = elements.toAmount.value;

      convert();
    }

    // Setup event listeners
    function setupEventListeners() {
      elements.fromAmount.addEventListener('input', convert);
      elements.fromCurrency.addEventListener('change', convert);
      elements.toCurrency.addEventListener('change', convert);
      elements.swapBtn.addEventListener('click', swap);
    }

    // Update last updated display
    function updateLastUpdatedDisplay() {
      if (lastUpdated) {
        const now = new Date();
        const diffMinutes = Math.floor((now - lastUpdated) / 1000 / 60);

        let timeText;
        if (diffMinutes < 1) {
          timeText = 'just now';
        } else if (diffMinutes < 60) {
          timeText = `${diffMinutes} minute${diffMinutes > 1 ? 's' : ''} ago`;
        } else {
          const diffHours = Math.floor(diffMinutes / 60);
          timeText = `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
        }

        elements.lastUpdated.textContent = `Rates updated ${timeText}`;
      }
    }

    // Show error
    function showError(message) {
      elements.error.textContent = message;
      elements.error.style.display = 'block';
      elements.loading.style.display = 'none';
    }

    // Start the app
    init();
  </script>
</body>
</html>
