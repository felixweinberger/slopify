name: Close Linked Issue

on:
  pull_request:
    types: [closed]

jobs:
  close-issue:
    # Only run if PR was merged (not just closed) and created by Claude
    if: github.event.pull_request.merged == true && github.event.pull_request.user.login == 'claude[bot]'
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Close linked issue
        run: |
          # Extract issue number from PR body (looks for "Closes #123" or "Fixes #123")
          ISSUE_NUM=$(echo "$PR_BODY" | grep -oP '(Closes|Fixes|Resolves)\s*#\K\d+' | head -1)

          if [ -n "$ISSUE_NUM" ]; then
            echo "Closing issue #$ISSUE_NUM"
            gh issue close "$ISSUE_NUM" --repo ${{ github.repository }} \
              --comment "âœ… Shipped in PR #${{ github.event.pull_request.number }}!"
          else
            echo "No linked issue found in PR body"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_BODY: ${{ github.event.pull_request.body }}
